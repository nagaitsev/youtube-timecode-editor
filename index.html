<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тайминги для YouTube видео</title>
    <style>
        /* Общие стили для всего документа */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%; /* Занимаем всю высоту viewport */
            overflow: hidden; /* Основной overflow будет управляться flex-контейнером */
            background-color: #f4f4f4;
            color: #333;
            font-family: 'Inter', Arial, sans-serif;
            line-height: 1.6;
        }

        /* Основной контейнер приложения, который будет grid-контейнером в ландшафте */
        .app-wrapper {
            display: flex;
            flex-direction: column; /* По умолчанию (портретный режим) - элементы располагаются в колонку */
            height: 100vh; /* Занимает всю высоту viewport */
            overflow: hidden; /* Управляем прокруткой внутри панелей */
        }

        /* Панель для видео и его элементов управления */
        .video-panel {
            flex-shrink: 0; /* Не сжимается в портретном режиме */
            background-color: #fff;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding-bottom: 25px; /* Отступ снизу для кнопок */
            overflow-y: auto; /* Прокрутка, если контент видеопанели не помещается */
            position: relative;
        }

        /* Панель для таймингов и секции вставки */
        .timings-panel {
            flex-grow: 1; /* Занимает все оставшееся пространство в портретном режиме */
            background-color: #f4f4f4;
            overflow-y: auto; /* Прокрутка для таймингов */
            padding-top: 20px; /* Отступ сверху для контента */
        }

        /* Внутренний контейнер для центрирования содержимого и отступов */
        .container-inner {
            max-width: 900px; /* Ограничение по умолчанию */
            margin: 0 auto;
            padding: 0 15px; /* Горизонтальные отступы */
        }

        /* Заголовок страницы */
        h1 {
            color: #0056b3;
            text-align: center;
            margin-top: 25px; /* Отступ сверху */
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: bold;
        }

        /* Секция ввода URL видео */
        .input-section {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            gap: 10px;
            flex-wrap: wrap;
        }
        .input-section input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input-section input[type="text"]:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
            outline: none;
        }
        .input-section button {
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease;
            white-space: nowrap;
        }
        .input-section button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }
        .input-section button:active {
            transform: translateY(0);
        }

        /* Контейнер для YouTube видеоплеера */
        .video-container {
            position: relative;
            width: 100%; /* Плеер всегда занимает 100% ширины своей панели */
            padding-bottom: 56.25%; /* Соотношение сторон 16:9 */
            height: 0; /* Важно для padding-bottom */
            overflow: hidden;
            background-color: #000;
            margin-bottom: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
            border-radius: 10px;
        }

        /* Секция кнопок управления таймингами */
        .controls {
            display: flex;
            justify-content: center;
            margin-top: 15px; /* Отступ сверху */
            margin-bottom: 0; /* Убираем нижний отступ, так как он есть у video-panel */
            gap: 15px;
            flex-wrap: wrap;
        }
        .controls button {
            padding: 14px 25px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 17px;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .controls button:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
        }
        .controls button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* Секция для вставки таймингов */
        .paste-section {
            margin-top: 30px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f0f8ff;
            border: 1px solid #cce7ff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .paste-section h3 {
            margin-top: 0;
            color: #007bff;
            text-align: center;
            margin-bottom: 15px;
        }
        .paste-section textarea {
            width: calc(100% - 24px);
            min-height: 80px;
            padding: 10px;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            font-size: 15px;
            resize: vertical;
            margin-bottom: 10px;
        }
        .paste-section button {
            width: 100%;
            padding: 12px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .paste-section button:hover {
            background-color: #5a6268;
            transform: translateY(-1px);
        }

        /* Стили для списка таймингов */
        #timingsList {
            background-color: #e9ecef;
            border: 1px solid #ddd;
            padding: 15px;
            min-height: 120px;
            border-radius: 8px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .timing-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ccc;
            gap: 10px;
        }
        .timing-item:last-child {
            border-bottom: none;
        }

        /* Общие стили для кнопок внутри timing-item */
        .timing-item button {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.2s ease;
            white-space: nowrap;
        }

        /* Стили для ссылки времени (для перехода по видео) */
        .timing-seek-link {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
            min-width: 60px;
            flex-shrink: 0;
            padding-top: 5px;
            display: inline-block;
        }
        .timing-seek-link:hover {
            text-decoration: underline;
        }

        /* Стили для поля ввода времени (для редактирования) */
        .timing-time-input {
            width: 60px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9em;
            text-align: center;
            flex-shrink: 0;
            display: none;
        }
        .timing-time-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
            outline: none;
        }

        /* Стили для кнопки редактирования */
        .edit-timing-btn {
            background-color: #ffc107;
            color: #333;
            border: none;
            margin-left: 5px;
            flex-shrink: 0;
        }
        .edit-timing-btn:hover {
            background-color: #e0a800;
        }

        /* Стили для текстового поля заметки */
        .timing-note-textarea {
            flex-grow: 1;
            margin-left: 15px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 15px;
            resize: vertical;
            min-height: 40px;
            max-height: 150px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .timing-note-textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
            outline: none;
        }

        /* Стили для кнопки удаления */
        .delete-timing-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            margin-left: 10px;
            flex-shrink: 0;
        }
        .delete-timing-btn:hover {
            background-color: #c82333;
        }

        /* Информационный текст */
        .info-text {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9em;
            color: #666;
            padding: 10px;
            background-color: #e0f7fa;
            border-left: 5px solid #00bcd4;
            border-radius: 5px;
        }

        /* Стили для разделителя */
        .splitter {
            width: 8px; /* Ширина разделителя */
            cursor: ew-resize; /* Курсор для горизонтального изменения размера */
            background-color: #ccc;
            flex-shrink: 0; /* Не сжимается */
            z-index: 101; /* Выше панелей */
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s;
        }
        .splitter:hover {
            background-color: #999;
        }
        .splitter.dragging {
            background-color: #007bff; /* Цвет при перетаскивании */
        }

        /* Медиа-запрос для горизонтальной ориентации (ландшафтный режим) */
        @media (orientation: landscape) {
            .app-wrapper {
                flex-direction: row; /* Элементы располагаются в строку */
                display: grid; /* Используем Grid для колонок */
                grid-template-columns: 3fr 8px 1fr; /* Начальное соотношение 3/4 видео, 8px разделитель, 1/4 тайминги */
                grid-template-rows: 1fr; /* Одна строка */
            }

            .video-panel {
                height: 100vh; /* Занимает всю высоту */
                overflow-y: auto; /* Прокрутка для видео-панели */
                box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1); /* Тень справа */
                padding-bottom: 25px; /* Отступ снизу для кнопок */
                grid-column: 1; /* Размещаем в первой колонке */
            }

            .timings-panel {
                height: 100vh; /* Занимает всю высоту */
                padding-top: 25px; /* Отступ сверху для контента */
                grid-column: 3; /* Размещаем в третьей колонке */
            }

            .splitter {
                grid-column: 2; /* Разделитель во второй колонке */
                height: 100vh; /* Занимает всю высоту */
            }

            /* В ландшафтном режиме container-inner должен расширяться на всю ширину панели */
            .video-panel .container-inner,
            .timings-panel .container-inner {
                max-width: none; /* Убираем ограничение max-width */
                padding: 0 15px; /* Сохраняем небольшой горизонтальный отступ */
            }

            .video-container {
                width: 100%; /* Плеер всегда занимает 100% ширины своей панели */
                padding-bottom: 56.25%; /* Сохраняем 16:9 */
                height: 0;
                margin-bottom: 15px; /* Уменьшаем отступ */
            }
            .video-container iframe {
                height: 100%; /* Iframe занимает всю высоту контейнера */
            }

            /* Ползунок скрыт в ландшафтном режиме */
            .player-height-slider {
                display: none;
            }

            h1 {
                margin-top: 0; /* Убираем верхний отступ, так как панель уже имеет свой padding-top */
            }
        }

        /* Медиа-запросы для мобильных устройств (портретный режим по умолчанию) */
        @media (max-width: 768px) {
            .fixed-header {
                padding-left: 10px; /* Уменьшаем горизонтальный отступ для мобильных */
                padding-right: 10px;
            }
            .container-inner {
                padding: 0; /* На мобильных устройствах убираем внутренний padding для максимальной ширины видео */
            }
            h1 {
                font-size: 1.8em;
            }
            .input-section {
                flex-direction: column;
                gap: 8px;
            }
            .input-section input[type="text"],
            .input-section button {
                width: 100%; /* Поле ввода и кнопка занимают всю ширину */
            }
            .controls {
                flex-direction: column;
                gap: 10px;
            }
            .controls button {
                width: 100%; /* Кнопки управления занимают всю ширину */
            }
            .timing-item {
                flex-direction: column;
                align-items: stretch;
                gap: 5px; /* Уменьшаем зазор на мобильных */
            }
            .timing-item a, .timing-item input, .timing-item button {
                margin-left: 0; /* Убираем горизонтальные отступы для кнопок и полей */
                margin-right: 0;
            }
            .timing-seek-link, .timing-time-input {
                width: 100%; /* Время занимает всю ширину */
                text-align: left;
            }
            .edit-timing-btn, .delete-timing-btn {
                width: 100%; /* Кнопки редактирования/удаления также занимают всю ширину */
                margin-left: 0;
                margin-right: 0;
            }
            .timing-note-textarea {
                margin-left: 0;
            }
            .paste-section textarea {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <!-- Видео-панель -->
        <div class="video-panel">
            <div class="container-inner">
                <h1>Тайминги для YouTube видео</h1>

                <div class="input-section">
                    <input type="text" id="youtubeUrl" placeholder="Вставьте ссылку на YouTube видео здесь">
                    <button onclick="loadVideo()">Загрузить видео</button>
                </div>

                <div class="video-container">
                    <iframe id="youtubePlayer" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                </div>

                <div class="controls">
                    <button id="addTimingBtn" onclick="addCurrentTime()" disabled>Добавить тайминг</button>
                    <button onclick="copyTimings()">Копировать тайминги</button>
                    <button onclick="clearTimings()">Очистить тайминги</button>
                </div>
            </div>
        </div>

        <!-- Разделитель (только для ландшафтного режима) -->
        <div class="splitter"></div>

        <!-- Панель таймингов -->
        <div class="timings-panel">
            <div class="container-inner">
                <div class="paste-section">
                    <h3>Вставить ранее скопированные тайминги</h3>
                    <textarea id="pasteTimingsTextarea" placeholder="Вставьте тайминги здесь. Каждый тайминг должен быть на новой строке, например: 01:23 Моя заметка"></textarea>
                    <button onclick="pasteTimings()">Вставить тайминги</button>
                </div>

                <h3>Ваши тайминги:</h3>
                <div id="timingsList">
                    Пока здесь нет таймингов. Добавьте видео и нажмите "Добавить тайминг".
                </div>
                <p class="info-text">
                    * Нажмите на тайм-код, чтобы перейти к этому моменту в видео.
                    <br>
                    * Ваши тайминги автоматически сохраняются в браузере.
                    <br>
                    * Для корректной работы YouTube API (чтобы видео показывалось и можно было добавлять тайминги),
                    страницу нужно открыть через локальный веб-сервер или на настоящем сервере.
                    Простое открытие файла в браузере может работать некорректно из-за ограничений безопасности браузеров.
                    <br>
                    * Если видео не загружается, убедитесь, что ссылка правильная (например, `https://www.youtube.com/watch?v=dQw4w9WgXcQ` или короткая `https://youtu.be/dQw4w9WgXcQ`).
                </p>
            </div>
        </div>
    </div>

    <script>
        let player; // Объект YouTube плеера
        let currentVideoId = ''; // ID текущего загруженного видео
        const timings = []; // Массив для хранения объектов таймингов
        let addTimingButton; // Ссылка на кнопку "Добавить тайминг"
        let videoContainer; // Ссылка на контейнер видео
        let videoPanel; // Ссылка на панель видео
        let timingsPanel; // Ссылка на панель таймингов
        let splitter; // Ссылка на разделитель
        let appWrapper; // Ссылка на основной контейнер

        // Автоматически определяет текущий домен для параметра 'origin' YouTube API
        const GITHUB_PAGES_ORIGIN = window.location.origin;

        /**
         * Загружает YouTube видео на страницу по введенному URL.
         */
        function loadVideo() {
            const url = document.getElementById('youtubeUrl').value;
            const videoId = getYouTubeVideoId(url); // Извлекаем ID видео из URL

            if (addTimingButton) {
                addTimingButton.disabled = true; // Отключаем кнопку при загрузке нового видео
            }

            if (videoId) {
                currentVideoId = videoId;
                const iframe = document.getElementById('youtubePlayer');
                // Обновляем src iframe для загрузки видео. enablejsapi=1 позволяет управлять плеером через JS.
                // Добавляем параметр 'origin' для корректной работы YouTube API на GitHub Pages.
                iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&origin=${encodeURIComponent(GITHUB_PAGES_ORIGIN)}`;

                // Инициализируем YouTube Iframe API, если он еще не загружен
                if (!player) {
                    const tag = document.createElement('script');
                    tag.src = "https://www.youtube.com/iframe_api"; // URL для загрузки YouTube Iframe API
                    const firstScriptTag = document.getElementsByTagName('script')[0];
                    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag); // Вставляем скрипт на страницу
                } else {
                    // Если плеер уже инициализирован, просто загружаем новое видео по ID
                    // onPlayerReady не будет вызван снова, поэтому используем onPlayerStateChange
                    player.loadVideoById(videoId);
                }
            } else {
                alert('Пожалуйста, введите корректную ссылку на YouTube видео.');
            }
        }

        /**
         * Функция, вызываемая YouTube Iframe API, когда он готов.
         * Инициализирует объект YT.Player.
         */
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtubePlayer', {
                events: {
                    'onReady': onPlayerReady, // Событие, когда плеер готов к работе
                    'onStateChange': onPlayerStateChange // Событие изменения состояния плеера
                }
            });
        }

        /**
         * Функция, вызываемая, когда YouTube плеер готов к воспроизведению.
         * @param {Object} event - Объект события плеера.
         */
        function onPlayerReady(event) {
            // Включаем кнопку "Добавить тайминг" после того, как плеер готов
            if (addTimingButton) {
                addTimingButton.disabled = false;
            }
            // Можно что-то сделать, когда плеер готов, например, начать воспроизведение
            // event.target.playVideo();
        }

        /**
         * Функция, вызываемая при изменении состояния плеера.
         * @param {Object} event - Объект события плеера.
         */
        function onPlayerStateChange(event) {
            // Включаем кнопку, если видео воспроизводится, на паузе или буферизуется
            if (addTimingButton) {
                if (event.data === YT.PlayerState.PLAYING ||
                    event.data === YT.PlayerState.PAUSED ||
                    event.data === YT.PlayerState.BUFFERING) {
                    addTimingButton.disabled = false;
                } else {
                    // Отключаем кнопку для других состояний (незагружено, закончилось, ошибка)
                    addTimingButton.disabled = true;
                }
            }
        }

        /**
         * Извлекает 11-значный ID видео из различных форматов ссылок YouTube.
         * @param {string} url - Полный URL YouTube видео.
         * @returns {string} - ID видео или пустая строка, если ID не найден.
         */
        function getYouTubeVideoId(url) {
            let videoId = '';
            // Регулярное выражение для извлечения ID из разных форматов YouTube ссылок
            const regExp = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
            const match = url.match(regExp);
            if (match && match[1]) {
                videoId = match[1];
            }
            return videoId;
        }

        /**
         * Добавляет текущее время воспроизведения видео в список таймингов.
         */
        function addCurrentTime() {
            // Проверяем, что плеер инициализирован и метод getCurrentTime доступен
            // А также что кнопка не отключена (что означает, что плеер готов)
            if (player && player.getCurrentTime && !addTimingButton.disabled) {
                const currentTime = Math.floor(player.getCurrentTime()); // Получаем текущее время в секундах
                const minutes = Math.floor(currentTime / 60);
                const seconds = currentTime % 60;
                // Форматируем время в MM:SS
                const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                const timingEntry = {
                    time: currentTime, // Время в секундах
                    formatted: formattedTime, // Отформатированное время
                    text: '' // Инициализируем пустое поле для заметки
                };
                timings.push(timingEntry); // Добавляем тайминг в массив
                renderTimings(); // Обновляем отображение списка таймингов
                saveTimings(); // Сохраняем изменения в localStorage
            } else {
                alert('Видео еще не готово. Пожалуйста, подождите, пока оно загрузится и начнет воспроизводиться.');
            }
        }

        /**
         * Рендерит (отображает) список таймингов на странице.
         * Каждый тайминг теперь включает текстовое поле для заметок.
         */
        function renderTimings() {
            const listElement = document.getElementById('timingsList');
            if (timings.length === 0) {
                listElement.innerHTML = 'Пока здесь нет таймингов. Добавьте видео и нажмите "Добавить тайминг".';
                return;
            }

            listElement.innerHTML = ''; // Очищаем текущее содержимое списка
            timings.forEach((entry, index) => {
                const div = document.createElement('div'); // Используем div для группировки ссылки и текстового поля
                div.className = 'timing-item'; // Добавляем класс для стилизации

                // Ссылка для перехода по видео
                const seekLink = document.createElement('a');
                seekLink.href = "#";
                seekLink.textContent = entry.formatted;
                seekLink.className = 'timing-seek-link';
                seekLink.onclick = (e) => {
                    e.preventDefault();
                    if (player && player.seekTo) {
                        player.seekTo(entry.time, true);
                    }
                };

                // Поле ввода для редактирования времени
                const timeInput = document.createElement('input');
                timeInput.type = 'text';
                timeInput.value = entry.formatted;
                timeInput.className = 'timing-time-input';
                timeInput.readOnly = true; // Изначально только для чтения
                timeInput.style.display = 'none'; // Изначально скрыто

                // Кнопка редактирования времени
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Ред.';
                editBtn.className = 'edit-timing-btn';
                editBtn.onclick = () => {
                    seekLink.style.display = 'none'; // Скрываем ссылку
                    timeInput.style.display = 'inline-block'; // Показываем поле ввода
                    timeInput.readOnly = false; // Разрешаем редактирование
                    timeInput.focus(); // Устанавливаем фокус
                };

                // Обработчик события потери фокуса для поля ввода времени (сохранение изменений)
                timeInput.onblur = () => {
                    const newTimeStr = timeInput.value;
                    const parsedTime = parseTimeToSeconds(newTimeStr);

                    if (!isNaN(parsedTime) && parsedTime >= 0) {
                        entry.time = parsedTime;
                        entry.formatted = formatSecondsToMMSS(parsedTime);
                        timings.sort((a, b) => a.time - b.time); // Пересортировываем после изменения времени
                        renderTimings(); // Перерисовываем список для обновления порядка и значений
                        saveTimings();
                    } else {
                        alert('Некорректный формат времени. Используйте ММ:СС (например, 01:23).');
                        timeInput.value = entry.formatted; // Возвращаем исходное значение
                    }
                    timeInput.readOnly = true;
                    timeInput.style.display = 'none';
                    seekLink.style.display = 'inline-block'; // Снова показываем ссылку
                };

                // Обработчик нажатия Enter для поля ввода времени
                timeInput.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Предотвращаем перенос строки
                        timeInput.blur(); // Вызываем событие blur для сохранения
                    }
                };

                // Текстовое поле для заметки
                const textarea = document.createElement('textarea');
                textarea.value = entry.text;
                textarea.rows = 2;
                textarea.placeholder = "Напишите заметку здесь...";
                textarea.className = 'timing-note-textarea';
                textarea.oninput = (e) => {
                    entry.text = e.target.value; // Обновляем текст заметки в массиве
                    saveTimings(); // Сохраняем изменения при каждом вводе
                };

                // Кнопка удаления
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Удалить';
                deleteBtn.className = 'delete-timing-btn';
                deleteBtn.onclick = () => {
                    if (confirm('Вы уверены, что хотите удалить этот тайминг?')) {
                        // Находим индекс элемента для удаления
                        const indexToDelete = timings.indexOf(entry);
                        if (indexToDelete > -1) {
                            timings.splice(indexToDelete, 1); // Удаляем из массива
                            renderTimings(); // Перерисовываем список
                            saveTimings(); // Сохраняем изменения
                        }
                    }
                };

                // Добавляем элементы в div тайминга
                div.appendChild(seekLink);
                div.appendChild(timeInput);
                div.appendChild(editBtn);
                div.appendChild(textarea);
                div.appendChild(deleteBtn);
                listElement.appendChild(div); // Добавляем div со всеми элементами в список
            });
        }

        /**
         * Копирует все отформатированные тайминги (включая заметки, если есть) в буфер обмена.
         * Каждая строка обрезается от лишних пробелов и пустые строки фильтруются.
         */
        function copyTimings() {
            // Собираем все тайминги и заметки в одну строку
            const textToCopy = timings.map(entry => {
                // Формируем строку для каждой записи: "ММ:СС Заметка" (без " - ")
                const line = entry.formatted + (entry.text ? ` ${entry.text}` : ''); // Только пробел
                return line.trim(); // Убираем любые лишние пробелы в начале/конце каждой строки
            }).filter(line => line.length > 0) // Фильтруем любые полностью пустые строки
              .join('\n'); // Объединяем строки с переносом на новую строку

            if (textToCopy) {
                // Используем Clipboard API для копирования текста
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        alert('Тайминги и заметки скопированы в буфер обмена!');
                    })
                    .catch(err => {
                        console.error('Ошибка при копировании: ', err);
                        alert('Не удалось скопировать тайминги. Попробуйте скопировать вручную.');
                    });
            } else {
                alert('Нет таймингов для копирования.');
            }
        }

        /**
         * Очищает все добавленные тайминги и заметки.
         */
        function clearTimings() {
            // Используем confirm для подтверждения действия (в реальном приложении лучше использовать кастомное модальное окно)
            if (confirm('Вы уверены, что хотите очистить все тайминги и заметки?')) {
                timings.length = 0; // Очищаем массив таймингов
                renderTimings(); // Обновляем отображение (показываем пустой список)
                saveTimings(); // Сохраняем пустое состояние в localStorage
                alert('Тайминги и заметки очищены.');
            }
        }

        /**
         * Сохраняет текущий массив таймингов в localStorage.
         */
        function saveTimings() {
            try {
                localStorage.setItem('videoTimings', JSON.stringify(timings));
            } catch (e) {
                console.error('Ошибка сохранения таймингов в localStorage:', e);
                alert('Не удалось сохранить тайминги автоматически. Возможно, закончилось место в хранилище браузера.');
            }
        }

        /**
         * Загружает тайминги из localStorage при загрузке страницы.
         */
        function loadTimings() {
            try {
                const savedTimings = localStorage.getItem('videoTimings');
                if (savedTimings) {
                    // Очищаем текущий массив перед заполнением
                    timings.length = 0;
                    // Парсим JSON и добавляем элементы в массив
                    const parsedTimings = JSON.parse(savedTimings);
                    parsedTimings.forEach(item => timings.push(item));
                }
            } catch (e) {
                console.error('Ошибка загрузки таймингов из localStorage:', e);
                alert('Не удалось загрузить сохраненные тайминги. Возможно, данные повреждены.');
                // Если данные повреждены, лучше очистить их, чтобы избежать дальнейших ошибок
                localStorage.removeItem('videoTimings');
                timings.length = 0;
            }
            renderTimings(); // Отображаем загруженные (или пустые) тайминги
        }

        /**
         * Вставляет тайминги из текстового поля, парсит их и добавляет к существующим.
         * Улучшена логика парсинга для обработки форматов "ММ:СС Заметка" и "ММ:СС - Заметка".
         */
        function pasteTimings() {
            const pastedText = document.getElementById('pasteTimingsTextarea').value;
            if (!pastedText.trim()) {
                alert('Пожалуйста, вставьте тайминги в текстовое поле.');
                return;
            }

            const lines = pastedText.split('\n');
            const newTimings = [];
            // Регулярное выражение для парсинга времени MM:SS в начале строки
            // Оно теперь ищет время, за которым может следовать пробел и любой текст
            const timeRegex = /^(\d{1,2}):(\d{2})\s*(.*)$/;
            let parsedCount = 0;

            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return; // Пропускаем пустые строки

                const match = trimmedLine.match(timeRegex);
                if (match) {
                    const minutes = parseInt(match[1], 10);
                    const seconds = parseInt(match[2], 10);
                    const totalSeconds = minutes * 60 + seconds;

                    let note = match[3] || ''; // Вся остальная часть строки после времени
                    // Если заметка начинается с " - ", удаляем этот разделитель
                    if (note.startsWith('- ')) {
                        note = note.substring(2).trim();
                    } else {
                        note = note.trim(); // Просто обрезаем пробелы, если нет " - "
                    }

                    newTimings.push({
                        time: totalSeconds,
                        formatted: `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`,
                        text: note
                    });
                    parsedCount++;
                } else {
                    console.warn(`Не удалось распознать тайминг в строке: "${trimmedLine}"`);
                    // Можно добавить оповещение пользователю о нераспознанных строках
                }
            });

            if (newTimings.length > 0) {
                // Добавляем новые тайминги к существующим
                timings.push(...newTimings);
                // Сортируем все тайминги по времени, чтобы они были в правильном порядке
                timings.sort((a, b) => a.time - b.time);

                renderTimings(); // Обновляем отображение
                saveTimings(); // Сохраняем обновленный список
                document.getElementById('pasteTimingsTextarea').value = ''; // Очищаем поле ввода
                alert(`Успешно добавлено ${parsedCount} таймингов.`);
            } else {
                alert('Не удалось распознать ни одного тайминга из вставленного текста. Убедитесь, что формат "ММ:СС Заметка" или "ММ:СС - Заметка", или просто "ММ:СС".');
            }
        }

        /**
         * Вспомогательная функция для парсинга строки времени (ММ:СС) в секунды.
         * @param {string} timeStr - Строка времени в формате ММ:СС.
         * @returns {number} - Общее количество секунд или NaN, если формат некорректен.
         */
        function parseTimeToSeconds(timeStr) {
            const parts = timeStr.split(':');
            if (parts.length === 2) {
                const minutes = parseInt(parts[0], 10);
                const seconds = parseInt(parts[1], 10);
                if (!isNaN(minutes) && !isNaN(seconds) && minutes >= 0 && seconds >= 0 && seconds < 60) {
                    return minutes * 60 + seconds;
                }
            }
            return NaN; // Возвращаем NaN для некорректного формата
        }

        /**
         * Вспомогательная функция для форматирования секунд в строку ММ:СС.
         * @param {number} totalSeconds - Общее количество секунд.
         * @returns {string} - Отформатированная строка времени.
         */
        function formatSecondsToMMSS(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        /**
         * Инициализирует функционал перетаскивания разделителя.
         */
        function setupSplitterDragging() {
            let isDragging = false;

            splitter.addEventListener('mousedown', (e) => {
                // Активируем перетаскивание только в ландшафтном режиме
                if (window.matchMedia("(orientation: landscape)").matches) {
                    isDragging = true;
                    splitter.classList.add('dragging');
                    document.body.style.cursor = 'ew-resize'; /* Изменяем курсор для всего body при перетаскивании */
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                }
            });

            // Обработчик для тач-событий (для мобильных устройств)
            splitter.addEventListener('touchstart', (e) => {
                if (window.matchMedia("(orientation: landscape)").matches) {
                    isDragging = true;
                    splitter.classList.add('dragging');
                    // document.body.style.cursor = 'ew-resize'; // Курсор не виден на тач-устройствах
                    document.addEventListener('touchmove', onTouchMove);
                    document.addEventListener('touchend', onTouchEnd);
                    e.preventDefault(); // Предотвращаем прокрутку страницы при перетаскивании
                }
            }, { passive: false }); // passive: false для preventDefault

            function onMouseMove(e) {
                if (!isDragging) return;
                updatePanelWidths(e.clientX);
            }

            function onTouchMove(e) {
                if (!isDragging || !e.touches[0]) return;
                updatePanelWidths(e.touches[0].clientX);
            }

            function updatePanelWidths(clientX) {
                const appWrapperRect = appWrapper.getBoundingClientRect();
                let newVideoPanelWidth = clientX - appWrapperRect.left;
                let totalWidth = appWrapperRect.width;

                // Ограничиваем минимальную и максимальную ширину панелей
                const minVideoWidth = totalWidth * 0.2; // Минимум 20% для видео
                const maxVideoWidth = totalWidth * 0.8; // Максимум 80% для видео

                if (newVideoPanelWidth < minVideoWidth) {
                    newVideoPanelWidth = minVideoWidth;
                } else if (newVideoPanelWidth > maxVideoWidth) {
                    newVideoPanelWidth = maxVideoWidth;
                }

                const videoPanelPercentage = (newVideoPanelWidth / totalWidth) * 100;
                const timingsPanelPercentage = 100 - videoPanelPercentage;

                // Обновляем grid-template-columns для app-wrapper
                appWrapper.style.gridTemplateColumns = `${videoPanelPercentage}% 8px ${timingsPanelPercentage}%`;
            }

            function onMouseUp() {
                isDragging = false;
                splitter.classList.remove('dragging');
                document.body.style.cursor = 'default'; /* Возвращаем стандартный курсор */
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }

            function onTouchEnd() {
                isDragging = false;
                splitter.classList.remove('dragging');
                document.removeEventListener('touchmove', onTouchMove);
                document.removeEventListener('touchend', onTouchEnd);
            }
        }

        /**
         * Устанавливает начальные размеры панелей в зависимости от ориентации.
         */
        function setInitialPanelSizes() {
            if (window.matchMedia("(orientation: portrait)").matches) {
                // Портретный режим: video-panel занимает 50% высоты, timings-panel - оставшееся
                videoPanel.style.height = '50vh'; /* Начальная высота видеопанели */
                videoPanel.style.flexBasis = 'auto'; /* Сброс для flexbox */
                videoPanel.style.maxWidth = 'none'; /* Сброс для flexbox */
                timingsPanel.style.flexBasis = 'auto'; /* Сброс для flexbox */
                timingsPanel.style.maxWidth = 'none'; /* Сброс для flexbox */
                appWrapper.style.gridTemplateColumns = 'none'; /* Сброс для grid */
                appWrapper.style.flexDirection = 'column'; /* Убедимся, что flex-direction column */
                splitter.style.display = 'none'; /* Скрываем разделитель в портретном режиме */

            } else {
                // Ландшафтный режим: video-panel 75%, timings-panel 25%
                videoPanel.style.height = '100vh'; /* Занимает всю высоту */
                appWrapper.style.gridTemplateColumns = '3fr 8px 1fr'; /* Начальное соотношение 3/4 и 1/4 */
                appWrapper.style.flexDirection = 'row'; /* Убедимся, что flex-direction row */
                splitter.style.display = 'block'; /* Показываем разделитель в ландшафтном режиме */
            }
        }


        // Инициализация при загрузке страницы: загружаем тайминги и отображаем их
        document.addEventListener('DOMContentLoaded', () => {
            loadTimings();
            // Получаем ссылки на элементы
            addTimingButton = document.getElementById('addTimingBtn');
            videoContainer = document.querySelector('.video-container');
            videoPanel = document.querySelector('.video-panel');
            timingsPanel = document.querySelector('.timings-panel');
            splitter = document.querySelector('.splitter');
            appWrapper = document.querySelector('.app-wrapper');

            // Изначально отключаем кнопку, пока видео не загружено и не готово
            if (addTimingButton) {
                addTimingButton.disabled = true;
            }

            // Устанавливаем начальные размеры панелей
            setInitialPanelSizes();

            // Инициализируем перетаскивание разделителя
            setupSplitterDragging();

            // Также настраиваем размеры панелей при изменении размера окна или ориентации
            window.addEventListener('resize', setInitialPanelSizes);
        });
    </script>
</body>
</html>
