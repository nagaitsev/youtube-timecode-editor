<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тайминги для YouTube видео</title>
    <style>
        /* Общие стили для всего документа */
        body {
            margin: 0; /* Убираем стандартные отступы body */
            padding-top: 0; /* Этот отступ будет установлен JavaScript для компенсации фиксированного заголовка */
            background-color: #f4f4f4;
            color: #333;
            font-family: 'Inter', Arial, sans-serif; /* Используем Inter, если доступен */
            line-height: 1.6;
            overflow-x: hidden; /* Предотвращаем горизонтальную прокрутку */
        }

        /* Фиксированный заголовок, который будет оставаться на месте при прокрутке */
        .fixed-header {
            position: fixed; /* Фиксируем элемент на экране */
            top: 0; /* Прикрепляем к верхней части экрана */
            left: 0;
            width: 100%; /* Занимает всю ширину */
            background-color: #fff; /* Белый фон, чтобы перекрывать прокручиваемый контент */
            z-index: 100; /* Гарантируем, что он находится поверх других элементов */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); /* Красивая тень */
            padding-top: 25px; /* Внутренний отступ сверху */
            padding-bottom: 25px; /* Внутренний отступ снизу */
        }

        /* Внутренний контейнер для центрирования содержимого внутри фиксированного заголовка и основного контента */
        .container-inner {
            max-width: 900px; /* Максимальная ширина, как у основного контейнера */
            margin: 0 auto; /* Центрирование */
            padding: 0 25px; /* Горизонтальные отступы */
        }

        /* Основная область контента, которая будет прокручиваться */
        .main-content {
            /* padding-top будет установлен JavaScript, чтобы содержимое не пряталось под фиксированным заголовком */
        }

        /* Заголовок страницы */
        h1 {
            color: #0056b3;
            text-align: center;
            margin-top: 0; /* Убираем верхний отступ, так как он уже есть у .fixed-header */
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: bold;
        }

        /* Секция ввода URL видео */
        .input-section {
            display: flex;
            margin-bottom: 25px;
            gap: 10px;
            flex-wrap: wrap;
        }
        .input-section input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input-section input[type="text"]:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
            outline: none;
        }
        .input-section button {
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease;
            white-space: nowrap;
        }
        .input-section button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }
        .input-section button:active {
            transform: translateY(0);
        }

        /* Контейнер для YouTube видеоплеера */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            background-color: #000;
            margin-bottom: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
            border-radius: 10px;
        }

        /* Секция кнопок управления таймингами */
        .controls {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 15px;
            flex-wrap: wrap;
        }
        .controls button {
            padding: 14px 25px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 17px;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .controls button:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
        }
        .controls button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* Секция для вставки таймингов */
        .paste-section {
            margin-top: 30px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f0f8ff;
            border: 1px solid #cce7ff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .paste-section h3 {
            margin-top: 0;
            color: #007bff;
            text-align: center;
            margin-bottom: 15px;
        }
        .paste-section textarea {
            width: calc(100% - 24px);
            min-height: 80px;
            padding: 10px;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            font-size: 15px;
            resize: vertical;
            margin-bottom: 10px;
        }
        .paste-section button {
            width: 100%;
            padding: 12px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .paste-section button:hover {
            background-color: #5a6268;
            transform: translateY(-1px);
        }

        /* Стили для списка таймингов */
        #timingsList {
            background-color: #e9ecef;
            border: 1px solid #ddd;
            padding: 15px;
            min-height: 120px;
            border-radius: 8px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px; /* Ограничиваем высоту списка */
            overflow-y: auto; /* Добавляем прокрутку, если таймингов много */
        }
        .timing-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ccc;
        }
        .timing-item:last-child {
            border-bottom: none;
        }
        .timing-item a {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
            min-width: 60px;
            flex-shrink: 0;
            padding-top: 5px;
        }
        .timing-item a:hover {
            text-decoration: underline;
        }
        .timing-item textarea {
            flex-grow: 1;
            margin-left: 15px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 15px;
            resize: vertical;
            min-height: 40px;
            max-height: 150px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .timing-item textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
            outline: none;
        }

        /* Информационный текст */
        .info-text {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9em;
            color: #666;
            padding: 10px;
            background-color: #e0f7fa;
            border-left: 5px solid #00bcd4;
            border-radius: 5px;
        }

        /* Медиа-запросы для адаптивности */
        @media (max-width: 768px) {
            .fixed-header {
                padding-left: 15px; /* Уменьшаем горизонтальный отступ для мобильных */
                padding-right: 15px;
            }
            .container-inner {
                padding: 0; /* Убираем внутренний padding, так как он уже есть у .fixed-header */
            }
            h1 {
                font-size: 1.8em;
            }
            .input-section {
                flex-direction: column;
                gap: 8px;
            }
            .input-section button {
                width: 100%;
            }
            .controls {
                flex-direction: column;
                gap: 10px;
            }
            .controls button {
                width: 100%;
            }
            .timing-item {
                flex-direction: column;
                align-items: stretch;
            }
            .timing-item a {
                margin-bottom: 5px;
            }
            .timing-item textarea {
                margin-left: 0;
            }
            .paste-section textarea {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Фиксированный заголовок -->
    <div class="fixed-header">
        <div class="container-inner">
            <h1>Тайминги для YouTube видео</h1>

            <div class="input-section">
                <input type="text" id="youtubeUrl" placeholder="Вставьте ссылку на YouTube видео здесь">
                <button onclick="loadVideo()">Загрузить видео</button>
            </div>

            <div class="video-container">
                <iframe id="youtubePlayer" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            </div>

            <div class="controls">
                <button id="addTimingBtn" onclick="addCurrentTime()" disabled>Добавить тайминг</button>
                <button onclick="copyTimings()">Копировать тайминги</button>
                <button onclick="clearTimings()">Очистить тайминги</button>
            </div>
        </div>
    </div>

    <!-- Основной прокручиваемый контент -->
    <div class="main-content">
        <div class="container-inner">
            <div class="paste-section">
                <h3>Вставить ранее скопированные тайминги</h3>
                <textarea id="pasteTimingsTextarea" placeholder="Вставьте тайминги здесь. Каждый тайминг должен быть на новой строке, например: 01:23 - Моя заметка"></textarea>
                <button onclick="pasteTimings()">Вставить тайминги</button>
            </div>

            <h3>Ваши тайминги:</h3>
            <div id="timingsList">
                Пока здесь нет таймингов. Добавьте видео и нажмите "Добавить тайминг".
            </div>
            <p class="info-text">
                * Нажмите на тайм-код, чтобы перейти к этому моменту в видео.
                <br>
                * Ваши тайминги автоматически сохраняются в браузере.
                <br>
                * Для корректной работы YouTube API (чтобы видео показывалось и можно было добавлять тайминги),
                страницу нужно открыть через локальный веб-сервер или на настоящем сервере.
                Простое открытие файла в браузере может работать некорректно из-за ограничений безопасности браузеров.
                <br>
                * Если видео не загружается, убедитесь, что ссылка правильная (например, `https://www.youtube.com/watch?v=dQw4w9WgXcQ` или короткая `https://youtu.be/dQw4w9WgXcQ`).
            </p>
        </div>
    </div>

    <script>
        let player; // Объект YouTube плеера
        let currentVideoId = ''; // ID текущего загруженного видео
        const timings = []; // Массив для хранения объектов таймингов
        let addTimingButton; // Ссылка на кнопку "Добавить тайминг"

        // Автоматически определяет текущий домен для параметра 'origin' YouTube API
        const GITHUB_PAGES_ORIGIN = window.location.origin;

        /**
         * Функция для динамической настройки отступа основного контента
         * для компенсации высоты фиксированного заголовка.
         */
        function adjustContentPadding() {
            const fixedHeader = document.querySelector('.fixed-header');
            const mainContent = document.querySelector('.main-content');
            if (fixedHeader && mainContent) {
                mainContent.style.paddingTop = fixedHeader.offsetHeight + 'px';
            }
        }

        /**
         * Загружает YouTube видео на страницу по введенному URL.
         */
        function loadVideo() {
            const url = document.getElementById('youtubeUrl').value;
            const videoId = getYouTubeVideoId(url); // Извлекаем ID видео из URL

            if (addTimingButton) {
                addTimingButton.disabled = true; // Отключаем кнопку при загрузке нового видео
            }

            if (videoId) {
                currentVideoId = videoId;
                const iframe = document.getElementById('youtubePlayer');
                // Обновляем src iframe для загрузки видео. enablejsapi=1 позволяет управлять плеером через JS.
                // Добавляем параметр 'origin' для корректной работы YouTube API на GitHub Pages.
                iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&origin=${encodeURIComponent(GITHUB_PAGES_ORIGIN)}`;

                // Инициализируем YouTube Iframe API, если он еще не загружен
                if (!player) {
                    const tag = document.createElement('script');
                    tag.src = "https://www.youtube.com/iframe_api"; // URL для загрузки YouTube Iframe API
                    const firstScriptTag = document.getElementsByTagName('script')[0];
                    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag); // Вставляем скрипт на страницу
                } else {
                    // Если плеер уже инициализирован, просто загружаем новое видео по ID
                    // onPlayerReady не будет вызван снова, поэтому используем onPlayerStateChange
                    player.loadVideoById(videoId);
                }
            } else {
                alert('Пожалуйста, введите корректную ссылку на YouTube видео.');
            }
        }

        /**
         * Функция, вызываемая YouTube Iframe API, когда он готов.
         * Инициализирует объект YT.Player.
         */
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtubePlayer', {
                events: {
                    'onReady': onPlayerReady, // Событие, когда плеер готов к работе
                    'onStateChange': onPlayerStateChange // Событие изменения состояния плеера
                }
            });
        }

        /**
         * Функция, вызываемая, когда YouTube плеер готов к воспроизведению.
         * @param {Object} event - Объект события плеера.
         */
        function onPlayerReady(event) {
            // Включаем кнопку "Добавить тайминг" после того, как плеер готов
            if (addTimingButton) {
                addTimingButton.disabled = false;
            }
            // Можно что-то сделать, когда плеер готов, например, начать воспроизведение
            // event.target.playVideo();
        }

        /**
         * Функция, вызываемая при изменении состояния плеера.
         * @param {Object} event - Объект события плеера.
         */
        function onPlayerStateChange(event) {
            // Включаем кнопку, если видео воспроизводится, на паузе или буферизуется
            if (addTimingButton) {
                if (event.data === YT.PlayerState.PLAYING ||
                    event.data === YT.PlayerState.PAUSED ||
                    event.data === YT.PlayerState.BUFFERING) {
                    addTimingButton.disabled = false;
                } else {
                    // Отключаем кнопку для других состояний (незагружено, закончилось, ошибка)
                    addTimingButton.disabled = true;
                }
            }
        }

        /**
         * Извлекает 11-значный ID видео из различных форматов ссылок YouTube.
         * @param {string} url - Полный URL YouTube видео.
         * @returns {string} - ID видео или пустая строка, если ID не найден.
         */
        function getYouTubeVideoId(url) {
            let videoId = '';
            // Регулярное выражение для извлечения ID из разных форматов YouTube ссылок
            const regExp = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
            const match = url.match(regExp);
            if (match && match[1]) {
                videoId = match[1];
            }
            return videoId;
        }

        /**
         * Добавляет текущее время воспроизведения видео в список таймингов.
         */
        function addCurrentTime() {
            // Проверяем, что плеер инициализирован и метод getCurrentTime доступен
            // А также что кнопка не отключена (что означает, что плеер готов)
            if (player && player.getCurrentTime && !addTimingButton.disabled) {
                const currentTime = Math.floor(player.getCurrentTime()); // Получаем текущее время в секундах
                const minutes = Math.floor(currentTime / 60);
                const seconds = currentTime % 60;
                // Форматируем время в MM:SS
                const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                const timingEntry = {
                    time: currentTime, // Время в секундах
                    formatted: formattedTime, // Отформатированное время
                    text: '' // Инициализируем пустое поле для заметки
                };
                timings.push(timingEntry); // Добавляем тайминг в массив
                renderTimings(); // Обновляем отображение списка таймингов
                saveTimings(); // Сохраняем изменения в localStorage
            } else {
                alert('Видео еще не готово. Пожалуйста, подождите, пока оно загрузится и начнет воспроизводиться.');
            }
        }

        /**
         * Рендерит (отображает) список таймингов на странице.
         * Каждый тайминг теперь включает текстовое поле для заметок.
         */
        function renderTimings() {
            const listElement = document.getElementById('timingsList');
            if (timings.length === 0) {
                listElement.innerHTML = 'Пока здесь нет таймингов. Добавьте видео и нажмите "Добавить тайминг".';
                return;
            }

            listElement.innerHTML = ''; // Очищаем текущее содержимое списка
            timings.forEach((entry, index) => {
                const div = document.createElement('div'); // Используем div для группировки ссылки и текстового поля
                div.className = 'timing-item'; // Добавляем класс для стилизации

                const link = document.createElement('a'); // Создаем ссылку
                link.href = "#"; // Устанавливаем href, чтобы ссылка была кликабельной, но не перезагружала страницу
                link.textContent = entry.formatted; // Текст ссылки - отформатированное время
                link.onclick = (e) => {
                    e.preventDefault(); // Предотвращаем стандартное действие ссылки (переход)
                    if (player && player.seekTo) {
                        // Перематываем видео к указанному времени (true означает, что воспроизведение начнется сразу)
                        player.seekTo(entry.time, true);
                    }
                };

                const textarea = document.createElement('textarea'); // Создаем текстовое поле
                textarea.value = entry.text; // Устанавливаем текущий текст заметки
                textarea.rows = 2; // Начальное количество строк
                textarea.placeholder = "Напишите заметку здесь...";
                textarea.oninput = (e) => {
                    entry.text = e.target.value; // Обновляем текст заметки в массиве
                    saveTimings(); // Сохраняем изменения при каждом вводе
                };

                div.appendChild(link);
                div.appendChild(textarea);
                listElement.appendChild(div); // Добавляем div со всеми элементами в список
            });
        }

        /**
         * Копирует все отформатированные тайминги (включая заметки, если есть) в буфер обмена.
         */
        function copyTimings() {
            // Собираем все тайминги и заметки в одну строку
            const textToCopy = timings.map(entry => {
                return entry.formatted + (entry.text ? ` - ${entry.text}` : '');
            }).join('\n');

            if (textToCopy) {
                // Используем Clipboard API для копирования текста
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        alert('Тайминги и заметки скопированы в буфер обмена!');
                    })
                    .catch(err => {
                        console.error('Ошибка при копировании: ', err);
                        alert('Не удалось скопировать тайминги. Попробуйте скопировать вручную.');
                    });
            } else {
                alert('Нет таймингов для копирования.');
            }
        }

        /**
         * Очищает все добавленные тайминги и заметки.
         */
        function clearTimings() {
            // Используем confirm для подтверждения действия (в реальном приложении лучше использовать кастомное модальное окно)
            if (confirm('Вы уверены, что хотите очистить все тайминги и заметки?')) {
                timings.length = 0; // Очищаем массив таймингов
                renderTimings(); // Обновляем отображение (показываем пустой список)
                saveTimings(); // Сохраняем пустое состояние в localStorage
                alert('Тайминги и заметки очищены.');
            }
        }

        /**
         * Сохраняет текущий массив таймингов в localStorage.
         */
        function saveTimings() {
            try {
                localStorage.setItem('videoTimings', JSON.stringify(timings));
            } catch (e) {
                console.error('Ошибка сохранения таймингов в localStorage:', e);
                alert('Не удалось сохранить тайминги автоматически. Возможно, закончилось место в хранилище браузера.');
            }
        }

        /**
         * Загружает тайминги из localStorage при загрузке страницы.
         */
        function loadTimings() {
            try {
                const savedTimings = localStorage.getItem('videoTimings');
                if (savedTimings) {
                    // Очищаем текущий массив перед заполнением
                    timings.length = 0;
                    // Парсим JSON и добавляем элементы в массив
                    const parsedTimings = JSON.parse(savedTimings);
                    parsedTimings.forEach(item => timings.push(item));
                }
            } catch (e) {
                console.error('Ошибка загрузки таймингов из localStorage:', e);
                alert('Не удалось загрузить сохраненные тайминги. Возможно, данные повреждены.');
                // Если данные повреждены, лучше очистить их, чтобы избежать дальнейших ошибок
                localStorage.removeItem('videoTimings');
                timings.length = 0;
            }
            renderTimings(); // Отображаем загруженные (или пустые) тайминги
        }

        /**
         * Вставляет тайминги из текстового поля, парсит их и добавляет к существующим.
         */
        function pasteTimings() {
            const pastedText = document.getElementById('pasteTimingsTextarea').value;
            if (!pastedText.trim()) {
                alert('Пожалуйста, вставьте тайминги в текстовое поле.');
                return;
            }

            const lines = pastedText.split('\n');
            const newTimings = [];
            // Регулярное выражение для парсинга времени MM:SS в начале строки
            const timeRegex = /^(\d{1,2}):(\d{2})/;
            let parsedCount = 0;

            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return; // Пропускаем пустые строки

                const match = trimmedLine.match(timeRegex);
                if (match) {
                    const minutes = parseInt(match[1], 10);
                    const seconds = parseInt(match[2], 10);
                    const totalSeconds = minutes * 60 + seconds;

                    let note = '';
                    // Ищем разделитель " - " для заметки
                    const noteStartIndex = trimmedLine.indexOf(' - ');
                    if (noteStartIndex !== -1) {
                        note = trimmedLine.substring(noteStartIndex + 3).trim();
                    }

                    newTimings.push({
                        time: totalSeconds,
                        formatted: `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`,
                        text: note
                    });
                    parsedCount++;
                } else {
                    console.warn(`Не удалось распознать тайминг в строке: "${trimmedLine}"`);
                    // Можно добавить оповещение пользователю о нераспознанных строках
                }
            });

            if (newTimings.length > 0) {
                // Добавляем новые тайминги к существующим
                timings.push(...newTimings);
                // Сортируем все тайминги по времени, чтобы они были в правильном порядке
                timings.sort((a, b) => a.time - b.time);

                renderTimings(); // Обновляем отображение
                saveTimings(); // Сохраняем обновленный список
                document.getElementById('pasteTimingsTextarea').value = ''; // Очищаем поле ввода
                alert(`Успешно добавлено ${parsedCount} таймингов.`);
            } else {
                alert('Не удалось распознать ни одного тайминга из вставленного текста. Убедитесь, что формат "ММ:СС - Ваша заметка" или просто "ММ:СС".');
            }
        }

        // Инициализация при загрузке страницы: загружаем тайминги и отображаем их
        document.addEventListener('DOMContentLoaded', () => {
            loadTimings();
            // Получаем ссылку на кнопку "Добавить тайминг"
            addTimingButton = document.getElementById('addTimingBtn');
            // Изначально отключаем кнопку, пока видео не загружено и не готово
            if (addTimingButton) {
                addTimingButton.disabled = true;
            }
            adjustContentPadding(); // Вызываем настройку отступа при загрузке
        });

        // Также настраиваем отступ при изменении размера окна (для адаптивности)
        window.addEventListener('resize', adjustContentPadding);
    </script>
</body>
</html>
